<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مافيا - لعبة التكتيك والخداع</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #1a202c; /* Deep charcoal */
            color: #e2e8f0; /* Off-white for text */
        }
        .container-bg {
            background-color: #2d3748; /* Darker gray for panels */
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #e53e3e; /* Red-600 */
            color: white;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #c53030; /* Darker red */
        }
        .btn-secondary {
            background-color: #3182ce; /* Blue-600 */
            color: white;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #2b6cb0; /* Darker blue */
        }
        .input-field {
            background-color: #4a5568; /* Gray-700 */
            border: 1px solid #2d3748;
            color: #e2e8f0;
        }
        .role-card-wrapper {
            perspective: 1000px;
        }
        .role-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .role-card.flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .card-front {
            background-color: #63b3ed; /* Light blue */
            color: #1a202c;
            border: 2px solid #3182ce;
        }
        .card-back {
            background-color: #e53e3e; /* Red-600 */
            color: white;
            transform: rotateY(180deg);
            border: 2px solid #c53030;
        }
        .mafia-color { color: #e53e3e; } /* Red */
        .civilian-color { color: #48bb78; } /* Green */
        .icon-small { width: 48px; height: 48px; }
        .player-status-card {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .player-status-alive {
            background-color: #2f855a; /* Green-700 */
        }
        .player-status-dead {
            background-color: #c53030; /* Red-700 */
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col justify-center items-center p-4">
    <div id="app" class="w-full max-w-4xl flex flex-col items-center">

        <div id="start-screen" class="w-full container-bg p-8 text-center">
            <h1 class="text-5xl font-extrabold mb-6 text-red-500">مافيا</h1>
            <p class="text-2xl mb-8 font-semibold">لعبة التكتيك والخداع الأونلاين (نسخة محلية)</p>
            
            <div id="player-names-container" class="mb-8">
                <label class="block text-lg font-bold mb-3">أسماء اللاعبين (5-15):</label>
                <div class="space-y-3 mb-4">
                    <input type="text" placeholder="اسم اللاعب 1" class="player-name w-full p-3 input-field rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" placeholder="اسم اللاعب 2" class="player-name w-full p-3 input-field rounded-lg text-center">
                    <input type="text" placeholder="اسم اللاعب 3" class="player-name w-full p-3 input-field rounded-lg text-center">
                    <input type="text" placeholder="اسم اللاعب 4" class="player-name w-full p-3 input-field rounded-lg text-center">
                    <input type="text" placeholder="اسم اللاعب 5" class="player-name w-full p-3 input-field rounded-lg text-center">
                </div>
                <button id="add-player-btn" class="btn-secondary px-6 py-3 rounded-lg text-lg">
                    إضافة لاعب
                </button>
            </div>
            
            <div class="mb-8">
                <label class="block text-lg font-bold mb-3">تخصيص الأدوار:</label>
                <div class="flex flex-wrap gap-6 justify-center text-lg">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="include-detective" checked class="h-5 w-5 text-blue-600 rounded mr-2 focus:ring-blue-500">
                        <span class="font-medium">شيخ (محقق)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="include-doctor" checked class="h-5 w-5 text-blue-600 rounded mr-2 focus:ring-blue-500">
                        <span class="font-medium">طبيب</span>
                    </label>
                </div>
            </div>
            
            <button id="start-game-btn" class="w-full btn-primary py-4 rounded-lg text-2xl">
                بدء اللعبة
            </button>
            <button id="how-to-play-btn" class="w-full btn-secondary py-3 rounded-lg text-lg mt-4">
                كيفية اللعب؟
            </button>
        </div>

        <div id="how-to-play-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="container-bg p-8 max-w-2xl w-full rounded-lg relative">
                <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-100 text-3xl font-bold">
                    &times;
                </button>
                <h2 class="text-3xl font-bold mb-6 text-center text-blue-400">كيف تلعب المافيا؟</h2>
                <div class="text-lg leading-relaxed text-right space-y-4">
                    <p>المافيا هي لعبة جماعية تعتمد على **الاستنتاج** و**الخداع**.</p>
                    <p>الهدف بسيط: **المدنيون** يحاولون كشف المافيا والتخلص منهم، بينما **المافيا** يحاولون القضاء على المدنيين سراً.</p>
                    <h3 class="text-xl font-bold text-blue-300 mt-6">الأدوار الأساسية:</h3>
                    <ul class="list-disc pr-6 space-y-2">
                        <li>**المافيا:** مهمتهم القتل ليلاً والتضليل نهاراً. يفوزون إذا أصبح عددهم مساوياً أو أكبر من عدد المدنيين.</li>
                        <li>**المدنيون:** ليس لديهم قوى خاصة، ويعتمدون على النقاش والتصويت لكشف المافيا.</li>
                        <li>**الشيخ (المحقق):** يمكنه التحقيق مع لاعب واحد كل ليلة لمعرفة دوره.</li>
                        <li>**الطبيب (الحامي):** يمكنه حماية لاعب واحد من القتل كل ليلة.</li>
                    </ul>
                    <h3 class="text-xl font-bold text-blue-300 mt-6">دورة اللعب:</h3>
                    <ol class="list-decimal pr-6 space-y-2">
                        <li>**توزيع الأدوار:** تُوزع الأدوار سراً في بداية اللعبة.</li>
                        <li>**الليل:**
                            <ul class="list-disc pr-6">
                                <li>تستيقظ المافيا وتختار من تقتل.</li>
                                <li>يستيقظ الشيخ ويحقق مع لاعب.</li>
                                <li>يستيقظ الطبيب ويختار من يحمي.</li>
                            </ul>
                        </li>
                        <li>**النهار:**
                            <ul class="list-disc pr-6">
                                <li>يُعلن عن ضحية الليل (إذا وُجدت).</li>
                                <li>يبدأ النقاش والتصويت العلني، ليُطرد اللاعب الذي يحصل على أكبر عدد من الأصوات.</li>
                            </ul>
                        </li>
                        <li>تتكرر دورة الليل والنهار حتى يفوز أحد الفريقين.</li>
                    </ol>
                    <p class="mt-6 font-bold text-yellow-300">تذكر: الصدق مطلوب فقط إذا كنت مدنياً! المافيا يجب أن تكذب وتضلل للبقاء!</p>
                </div>
            </div>
        </div>

        <div id="role-assignment-screen" class="hidden w-full container-bg p-8 text-center">
            <h2 class="text-4xl font-bold mb-8 text-blue-400">تعرف على دورك</h2>
            
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6 mb-8" id="role-cards-container">
                </div>
            
            <button id="confirm-roles-btn" class="btn-primary px-8 py-4 rounded-lg text-xl">
                ابدأ الجولة الأولى (النهار)
            </button>
        </div>

        <div id="game-screen" class="hidden w-full container-bg p-8">
            <div class="bg-gray-700 rounded-lg p-4 mb-6 flex justify-between items-center shadow-md">
                <div id="game-phase" class="text-2xl font-bold text-blue-300">النهار: النقاش</div>
                <div id="timer" class="text-3xl font-extrabold text-green-400">02:00</div>
            </div>
            
            <div id="game-content" class="bg-gray-700 rounded-lg p-6 mb-6 min-h-[200px] flex flex-col justify-center items-center text-center text-xl shadow-md">
                </div>
            
            <div class="bg-gray-700 rounded-lg p-4 mb-6 shadow-md">
                <h3 class="text-xl font-bold mb-3 text-blue-300">اللاعبون الأحياء:</h3>
                <div id="alive-players-list" class="flex flex-wrap gap-3 justify-center">
                    </div>
            </div>

            <div id="controls" class="bg-gray-700 rounded-lg p-4 text-center shadow-md">
                </div>
        </div>

        <div id="end-screen" class="hidden w-full container-bg p-8 text-center">
            <h2 id="winner-text" class="text-4xl font-extrabold mb-8 text-yellow-400"></h2>
            
            <div id="players-summary" class="bg-gray-700 rounded-lg p-6 mb-8 max-h-96 overflow-y-auto shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-blue-300">ملخص الأدوار:</h3>
                </div>
            
            <button id="new-game-btn" class="btn-primary px-8 py-4 rounded-lg text-xl">
                لعبة جديدة
            </button>
        </div>
    </div>

    <script>
        // حالة اللعبة
        const gameState = {
            players: [],
            roles: [],
            currentPhase: 'day', // 'day_discussion', 'day_voting', 'night_mafia', 'night_detective', 'night_doctor'
            currentRound: 0, // يبدأ من 0 ليلة التعريف
            gameStarted: false,
            timer: null,
            timeLeft: 0,
            lastDetectiveTargetId: null,
            lastDoctorTargetId: null,
            mafiaChosenTargetId: null, // الهدف الذي اختارته المافيا
            doctorSavedTargetId: null, // الهدف الذي أنقذه الطبيب
            victimThisRound: null, // اللاعب الذي مات في الجولة
            votedOutPlayerId: null, // اللاعب الذي تم التصويت عليه للخروج
            playersWhoVoted: new Set(), // لتعقب من صوت في التصويت
            currentVoteCounts: {} // لتخزين عدد أصوات كل لاعب
        };

        // الأدوار المتاحة وبياناتها
        const ROLES = {
            MAFIA: {
                name: 'مافيا',
                description: 'أنت من المافيا. هدفك قتل المدنيين ليلاً وتضليلهم نهاراً. تعاون مع رفاقك المافيا.',
                image: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/f440608d-4a87-4300-a04c-e66d3b1c4ef4.png',
                team: 'mafia',
                nightAction: true,
                cardColor: 'bg-red-700'
            },
            CIVILIAN: {
                name: 'مدني',
                description: 'أنت مواطن بريء. هدفك كشف المافيا بالنقاش والتصويت وإخراجهم من اللعبة.',
                image: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/279a12f1-d19c-468d-836b-bddcc5d517de.png',
                team: 'civilians',
                nightAction: false,
                cardColor: 'bg-green-700'
            },
            DETECTIVE: {
                name: 'شيخ (محقق)',
                description: 'يمكنك التحقيق مع لاعب واحد كل ليلة لمعرفة ما إذا كان مافيا أم لا.',
                image: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86c1-3327d3870f43.png',
                team: 'civilians',
                nightAction: true,
                cardColor: 'bg-blue-700'
            },
            DOCTOR: {
                name: 'طبيب',
                description: 'يمكنك حماية لاعب واحد من القتل كل ليلة. لا يمكنك حماية نفسك مرتين متتاليتين.',
                image: 'https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/fe132ab2-057f-4f03-9170-88071dd8215b.png',
                team: 'civilians',
                nightAction: true,
                cardColor: 'bg-yellow-700'
            }
        };

        // عناصر واجهة المستخدم
        const UI = {
            startScreen: document.getElementById('start-screen'),
            howToPlayModal: document.getElementById('how-to-play-modal'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            roleAssignmentScreen: document.getElementById('role-assignment-screen'),
            gameScreen: document.getElementById('game-screen'),
            endScreen: document.getElementById('end-screen'),
            playerNamesContainer: document.getElementById('player-names-container'),
            addPlayerBtn: document.getElementById('add-player-btn'),
            includeDetective: document.getElementById('include-detective'),
            includeDoctor: document.getElementById('include-doctor'),
            startGameBtn: document.getElementById('start-game-btn'),
            howToPlayBtn: document.getElementById('how-to-play-btn'),
            confirmRolesBtn: document.getElementById('confirm-roles-btn'),
            newGameBtn: document.getElementById('new-game-btn'),
            gamePhase: document.getElementById('game-phase'),
            timer: document.getElementById('timer'),
            gameContent: document.getElementById('game-content'),
            controls: document.getElementById('controls'),
            winnerText: document.getElementById('winner-text'),
            playersSummary: document.getElementById('players-summary'),
            roleCardsContainer: document.getElementById('role-cards-container'),
            alivePlayersList: document.getElementById('alive-players-list')
        };

        // ========== الأحداث ==========
        UI.addPlayerBtn.addEventListener('click', () => {
            const currentInputs = document.querySelectorAll('.player-name');
            if (currentInputs.length >= 15) {
                alert('لقد وصلت للحد الأقصى من اللاعبين (15)!');
                return;
            }
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.placeholder = `اسم اللاعب ${currentInputs.length + 1}`;
            newInput.className = 'player-name w-full p-3 input-field rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500';
            UI.playerNamesContainer.querySelector('div').appendChild(newInput);
        });

        UI.startGameBtn.addEventListener('click', startGame);
        UI.confirmRolesBtn.addEventListener('click', confirmRoles);
        UI.newGameBtn.addEventListener('click', () => {
            resetGame();
            UI.endScreen.classList.add('hidden');
            UI.startScreen.classList.remove('hidden');
            // إعادة تعيين حقول أسماء اللاعبين
            const defaultPlayerInputs = `
                <input type="text" placeholder="اسم اللاعب 1" class="player-name w-full p-3 input-field rounded-lg text-center">
                <input type="text" placeholder="اسم اللاعب 2" class="player-name w-full p-3 input-field rounded-lg text-center">
                <input type="text" placeholder="اسم اللاعب 3" class="player-name w-full p-3 input-field rounded-lg text-center">
                <input type="text" placeholder="اسم اللاعب 4" class="player-name w-full p-3 input-field rounded-lg text-center">
                <input type="text" placeholder="اسم اللاعب 5" class="player-name w-full p-3 input-field rounded-lg text-center">
            `;
            UI.playerNamesContainer.querySelector('div').innerHTML = defaultPlayerInputs;
            UI.includeDetective.checked = true;
            UI.includeDoctor.checked = true;
        });

        UI.howToPlayBtn.addEventListener('click', () => {
            UI.howToPlayModal.classList.remove('hidden');
        });
        UI.closeModalBtn.addEventListener('click', () => {
            UI.howToPlayModal.classList.add('hidden');
        });

        // ========== وظائف اللعبة الأساسية ==========

        // بدء اللعبة - تحضير الأدوار واللاعبين
        function startGame() {
            const nameInputs = document.querySelectorAll('.player-name');
            const playerNames = Array.from(nameInputs)
                .map(input => input.value.trim())
                .filter(name => name !== '');
            
            const includeDetective = UI.includeDetective.checked;
            const includeDoctor = UI.includeDoctor.checked;
            
            if (playerNames.length < 5 || playerNames.length > 15) {
                alert('يجب إدخال أسماء لعدد لاعبين بين 5 و15.');
                return;
            }
            
            createRolesDistribution(playerNames.length, includeDetective, includeDoctor);
            
            // تحديث أسماء اللاعبين
            gameState.players.forEach((player, index) => {
                player.name = playerNames[index] || `لاعب ${index + 1}`; // fallback name
            });
            
            UI.startScreen.classList.add('hidden');
            UI.roleAssignmentScreen.classList.remove('hidden');
            showRoleCards();
        }

        // توزيع الأدوار
        function createRolesDistribution(playerCount, includeDetective, includeDoctor) {
            gameState.roles = [];
            
            // حساب عدد المافيا (1 مافيا لكل 3-4 لاعبين)
            const mafiaCount = Math.max(1, Math.floor(playerCount / 4)); 
            
            for (let i = 0; i < mafiaCount; i++) {
                gameState.roles.push(ROLES.MAFIA);
            }
            
            if (includeDetective) gameState.roles.push(ROLES.DETECTIVE);
            if (includeDoctor) gameState.roles.push(ROLES.DOCTOR);
            
            // إضافة المدنيين لملء باقي الأدوار
            while (gameState.roles.length < playerCount) {
                gameState.roles.push(ROLES.CIVILIAN);
            }
            
            // خلط الأدوار عشوائياً
            gameState.roles = shuffleArray(gameState.roles);
            
            // إنشاء قائمة اللاعبين وتعيين الأدوار
            gameState.players = [];
            for (let i = 0; i < playerCount; i++) {
                gameState.players.push({
                    id: i + 1,
                    name: `لاعب ${i + 1}`,
                    role: gameState.roles[i],
                    alive: true,
                    protected: false, // للحماية المؤقتة في الليل
                    lastProtectedRound: -1, // لتتبع آخر جولة تم فيها حماية نفسه
                    lastInvestigatedRound: -1 // لتتبع آخر جولة تم فيها التحقيق
                });
            }
        }

        // عرض بطاقات الأدوار
        function showRoleCards() {
            UI.roleCardsContainer.innerHTML = '';
            
            gameState.players.forEach((player) => {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'role-card-wrapper';
                
                const card = document.createElement('div');
                card.className = 'role-card';
                card.dataset.playerId = player.id;
                
                card.innerHTML = `
                    <div class="card-face card-front">
                        <div class="text-2xl font-bold mb-3">${player.name}</div>
                        <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/58733c6f-6964-4eb2-9e03-c4bd4229d944.png" alt="بطاقة دور اللاعب" class="icon-large mb-2">
                        <p class="text-base text-gray-800">اضغط لترى دورك</p>
                    </div>
                    <div class="card-face card-back ${player.role.cardColor}">
                        <h3 class="text-3xl font-extrabold mb-2">${player.role.name}</h3>
                        <img src="${player.role.image}" alt="دور ${player.role.name}" class="icon-large mb-3">
                        <p class="text-sm px-2">${player.role.description}</p>
                        <p class="text-sm font-bold mt-2">${player.role.team === 'mafia' ? 'أنت مافيا' : 'أنت مدني'}</p>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    card.classList.toggle('flipped');
                });
                
                cardWrapper.appendChild(card);
                UI.roleCardsContainer.appendChild(cardWrapper);
            });
        }

        // تأكيد الأدوار وبدء اللعب
        function confirmRoles() {
            UI.roleAssignmentScreen.classList.add('hidden');
            UI.gameScreen.classList.remove('hidden');
            startGameLoop();
        }

        // حلقة اللعبة الرئيسية - تبدأ بالنهار
        function startGameLoop() {
            gameState.gameStarted = true;
            startDayPhase();
        }

        // بدء مرحلة النهار (نقاش)
        function startDayPhase() {
            gameState.currentPhase = 'day_discussion';
            gameState.currentRound++; // الجولة الأولى هي جولة النقاش الأولى
            gameState.timeLeft = 180; // 3 دقائق للنقاش
            UI.gamePhase.textContent = `النهار ${gameState.currentRound}: النقاش`;
            UI.timer.textContent = formatTime(gameState.timeLeft);
            
            // إعلان ضحية الليل السابقة
            let victimMessage = '';
            if (gameState.victimThisRound) {
                victimMessage = `<p class="text-2xl font-bold text-red-400 mb-4">${gameState.victimThisRound.name} (${gameState.victimThisRound.role.name}) قد قُتل الليلة الماضية!</p>`;
                gameState.victimThisRound = null; // إعادة تعيين الضحية
            } else {
                victimMessage = '<p class="text-2xl font-bold text-green-400 mb-4">ليلة هادئة... لم يقتل أحد!</p>';
            }
            
            updateGameContent(`${victimMessage}<p class="text-lg">حان وقت النقاش. حاولوا كشف المافيا!</p>`);
            updateControls('<button id="start-voting-btn" class="btn-secondary px-6 py-3 rounded-lg text-lg">بدء التصويت</button>');
            document.getElementById('start-voting-btn').addEventListener('click', startVotingPhase);
            
            startTimer(startVotingPhase); // إذا انتهى الوقت، ابدأ التصويت تلقائياً
            updateAlivePlayersList();
            checkGameEnd(); // التحقق بعد كل نهار
        }

        // بدء مرحلة التصويت
        function startVotingPhase() {
            clearInterval(gameState.timer); // إيقاف مؤقت النقاش
            gameState.currentPhase = 'day_voting';
            gameState.timeLeft = 60; // دقيقة واحدة للتصويت
            UI.gamePhase.textContent = `النهار ${gameState.currentRound}: التصويت`;
            UI.timer.textContent = formatTime(gameState.timeLeft);
            gameState.currentVoteCounts = {}; // إعادة تعيين الأصوات
            gameState.playersWhoVoted.clear(); // إعادة تعيين من صوت
            
            const alivePlayers = gameState.players.filter(p => p.alive);
            
            let content = '<p class="text-xl mb-4 font-bold">صوتوا لإخراج شخص من اللعبة:</p>';
            content += '<div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-4">';
            
            alivePlayers.forEach(player => {
                content += `
                    <button data-player-id="${player.id}" class="vote-btn bg-gray-700 hover:bg-gray-600 p-4 rounded-lg flex flex-col items-center justify-center transition-all duration-200">
                        <span class="text-2xl font-bold">${player.name}</span>
                        <span class="text-sm text-gray-400 mt-1">الأصوات: <span class="vote-count" id="vote-count-${player.id}">0</span></span>
                    </button>
                `;
            });
            content += '</div>';
            
            updateGameContent(content);
            updateControls('<p class="text-lg text-blue-300">انتظر تصويت جميع اللاعبين.</p>'); // رسالة للاعبين
            
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    handleVote(parseInt(btn.dataset.playerId), event);
                });
            });
            
            startTimer(processVotingResults); // إذا انتهى الوقت، عالج النتائج تلقائياً
        }

        // التعامل مع التصويت الفردي
        function handleVote(votedPlayerId, event) {
            // هنا، في اللعب المحلي، كل ضغطة تعتبر تصويتاً. في الأونلاين، يجب ربط هذا باللاعب الذي يضغط.
            // لتبسيط الـ MVP، نعتبر أن أي ضغطة تحسب صوتًا.
            // في اللعب المحلي (تمرير الجهاز)، يجب أن يكون هناك طريقة لتسجيل صوت كل لاعب على حدة،
            // أو جعل "مدير اللعبة" يدخل الأصوات يدوياً.
            // للحفاظ على بساطة الـ MVP، سنفترض أن اللاعبين يضغطون على الزر ويتم احتساب الصوت.
            
            // Simulate each player voting (in a local game, this would be more complex)
            // For now, each click increments the count.
            gameState.currentVoteCounts[votedPlayerId] = (gameState.currentVoteCounts[votedPlayerId] || 0) + 1;
            
            // Update UI for vote count
            const voteCountSpan = document.getElementById(`vote-count-${votedPlayerId}`);
            if (voteCountSpan) {
                voteCountSpan.textContent = gameState.currentVoteCounts[votedPlayerId];
            }
            
            // Disable button after vote (simulate one vote per player) - For simplicity in local play
            event.target.closest('.vote-btn').disabled = true;
            event.target.closest('.vote-btn').classList.add('opacity-50', 'cursor-not-allowed');

            // بعد كل تصويت، يمكننا فحص إذا كان جميع اللاعبين الأحياء قد صوتوا (ليس عملياً في Local MVP إلا لو كان هناك زر "تم التصويت")
            // سنعتمد على المؤقت للمعالجة النهائية.
        }

        // معالجة نتائج التصويت
        function processVotingResults() {
            clearInterval(gameState.timer); // إيقاف مؤقت التصويت
            
            const voteCounts = gameState.currentVoteCounts;
            let maxVotes = 0;
            let playersWithMaxVotes = [];
            
            for (const playerId in voteCounts) {
                const count = voteCounts[playerId];
                if (count > maxVotes) {
                    maxVotes = count;
                    playersWithMaxVotes = [parseInt(playerId)];
                } else if (count === maxVotes && maxVotes > 0) {
                    playersWithMaxVotes.push(parseInt(playerId));
                }
            }

            // قاعدة التعادل: لا أحد يخرج
            if (playersWithMaxVotes.length > 1 || maxVotes === 0) {
                gameState.votedOutPlayerId = null;
                updateGameContent('<p class="text-2xl font-bold text-yellow-400 mb-4">تعادل في التصويت! لم يتم إخراج أحد هذه الجولة.</p>');
            } else {
                gameState.votedOutPlayerId = playersWithMaxVotes[0];
                const votedOutPlayer = gameState.players.find(p => p.id === gameState.votedOutPlayerId);
                votedOutPlayer.alive = false; // إخراج اللاعب
                updateGameContent(`<p class="text-2xl font-bold text-red-400 mb-4">${votedOutPlayer.name} (${votedOutPlayer.role.name}) تم التصويت عليه وإخراجه من اللعبة!</p>`);
            }
            
            updateControls('<button id="next-phase-btn" class="btn-primary px-6 py-3 rounded-lg text-lg">الانتقال لليلة</button>');
            document.getElementById('next-phase-btn').addEventListener('click', startNightPhase);
            
            updateAlivePlayersList();
            checkGameEnd(); // التحقق بعد كل تصويت
        }

        // بدء مرحلة الليل
        function startNightPhase() {
            clearInterval(gameState.timer); // إيقاف مؤقت النهار
            gameState.currentPhase = 'night';
            gameState.timeLeft = 90; // دقيقة ونصف للمرحلة الليلية
            UI.gamePhase.textContent = `الليل ${gameState.currentRound}`;
            UI.timer.textContent = formatTime(gameState.timeLeft);
            
            // إعادة تعيين الحماية للجولة الجديدة
            gameState.players.forEach(p => p.protected = false);
            gameState.mafiaChosenTargetId = null;
            gameState.doctorSavedTargetId = null;

            updateGameContent('<p class="text-xl text-blue-300">الجميع ينام... حان وقت الأدوار الخاصة!</p>');
            
            const alivePlayers = gameState.players.filter(p => p.alive);
            const mafiaPlayers = alivePlayers.filter(p => p.role.team === 'mafia');
            const detective = alivePlayers.find(p => p.role.name === ROLES.DETECTIVE.name);
            const doctor = alivePlayers.find(p => p.role.name === ROLES.DOCTOR.name);
            
            let actionsHTML = '<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">';
            let hasNightAction = false; // لتحديد ما إذا كان هناك أي إجراء ليلي مطلوب

            // إجراءات المافيا
            if (mafiaPlayers.length > 0) {
                hasNightAction = true;
                const targets = alivePlayers.filter(p => p.role.team !== 'mafia');
                if (targets.length > 0) {
                     actionsHTML += `
                        <div class="bg-gray-800 p-5 rounded-lg shadow-inner">
                            <h3 class="text-xl font-bold mb-3 text-red-400">المافيا: اختر هدفاً للقتل</h3>
                            <select id="mafia-target" class="w-full p-3 input-field rounded-lg mb-3">
                                ${targets.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else { // No civilian targets left, mafia won
                    actionsHTML += `<div class="bg-gray-800 p-5 rounded-lg shadow-inner"><h3 class="text-xl font-bold mb-3 text-red-400">المافيا: لا يوجد مدنيون لاستهدافهم!</h3></div>`;
                    hasNightAction = false; // No action needed if mafia won
                }
            }
            
            // إجراء الشيخ (إن وجد)
            if (detective) {
                hasNightAction = true;
                const targets = alivePlayers.filter(p => p.id !== detective.id); // لا يستطيع التحقيق مع نفسه
                const validTargets = targets.filter(p => p.id !== gameState.lastDetectiveTargetId);
                
                actionsHTML += `
                    <div class="bg-gray-800 p-5 rounded-lg shadow-inner">
                        <h3 class="text-xl font-bold mb-3 text-blue-400">الشيخ: اختر لاعباً للتحقيق</h3>
                        <select id="detective-target" class="w-full p-3 input-field rounded-lg mb-3" ${validTargets.length === 0 ? 'disabled' : ''}>
                            ${validTargets.length > 0 ? validTargets.map(t => `<option value="${t.id}">${t.name}</option>`).join('') : '<option value="">لا يوجد أهداف متاحة</option>'}
                        </select>
                        ${validTargets.length === 0 ? '<p class="text-red-300 text-sm">لا يمكنك التحقيق مع نفس الشخص ليلتين متتاليتين.</p>' : ''}
                        <p id="detective-result" class="text-center font-bold mt-2"></p>
                    </div>
                `;
            }
            
            // إجراء الطبيب (إن وجد)
            if (doctor) {
                hasNightAction = true;
                const targets = alivePlayers;
                const validTargets = targets.filter(p => !(p.id === doctor.id && doctor.lastProtectedRound === gameState.currentRound -1)); // لا يحمي نفسه مرتين متتاليتين
                
                actionsHTML += `
                    <div class="bg-gray-800 p-5 rounded-lg shadow-inner">
                        <h3 class="text-xl font-bold mb-3 text-yellow-400">الطبيب: اختر لاعباً لحمايته</h3>
                        <select id="doctor-target" class="w-full p-3 input-field rounded-lg mb-3" ${validTargets.length === 0 ? 'disabled' : ''}>
                            ${validTargets.length > 0 ? validTargets.map(t => `<option value="${t.id}">${t.name}</option>`).join('') : '<option value="">لا يوجد أهداف متاحة</option>'}
                        </select>
                        ${validTargets.length === 0 ? '<p class="text-red-300 text-sm">لا يمكنك حماية نفسك مرتين متتاليتين.</p>' : ''}
                    </div>
                `;
            }
            
            actionsHTML += '</div>';
            
            updateGameContent(actionsHTML);
            
            if (hasNightAction) {
                updateControls('<button id="submit-night-actions-btn" class="btn-primary px-6 py-3 rounded-lg text-lg">تأكيد الإجراءات الليلية</button>');
                document.getElementById('submit-night-actions-btn').addEventListener('click', processNightActions);
            } else {
                updateControls('<p class="text-lg text-gray-400">لا توجد إجراءات ليلية في هذه الجولة.</p><button id="skip-night-btn" class="btn-primary px-6 py-3 rounded-lg text-lg mt-4">الانتقال للنهار</button>');
                document.getElementById('skip-night-btn').addEventListener('click', nextPhase);
            }
            
            startTimer(processNightActions); // إذا انتهى الوقت، عالج الإجراءات تلقائياً
        }

        // معالجة الإجراءات الليلية
        function processNightActions() {
            clearInterval(gameState.timer); // إيقاف مؤقت الليل
            
            // 1. معالجة اختيار المافيا (أغلبية بسيطة)
            const mafiaTargetSelect = document.getElementById('mafia-target');
            if (mafiaTargetSelect && mafiaTargetSelect.value) {
                // في اللعب المحلي، هذا يعني أن شخصًا واحدًا فقط سيضغط.
                // في الأونلاين، يجب جمع أصوات المافيا هنا.
                gameState.mafiaChosenTargetId = parseInt(mafiaTargetSelect.value);
            }

            // 2. معالجة اختيار الطبيب
            const doctorTargetSelect = document.getElementById('doctor-target');
            if (doctorTargetSelect && doctorTargetSelect.value) {
                const doctor = gameState.players.find(p => p.role.name === ROLES.DOCTOR.name);
                if (doctor) {
                    gameState.doctorSavedTargetId = parseInt(doctorTargetSelect.value);
                    doctor.lastProtectedRound = gameState.currentRound; // تحديث آخر جولة حماية للطبيب
                }
            }

            // 3. معالجة اختيار الشيخ
            const detectiveTargetSelect = document.getElementById('detective-target');
            if (detectiveTargetSelect && detectiveTargetSelect.value) {
                const detective = gameState.players.find(p => p.role.name === ROLES.DETECTIVE.name);
                if (detective) {
                    const investigatedPlayer = gameState.players.find(p => p.id === parseInt(detectiveTargetSelect.value));
                    gameState.lastDetectiveTargetId = investigatedPlayer.id; // تحديث آخر جولة تحقيق للشيخ
                    const detectiveResultElement = document.getElementById('detective-result');
                    if (detectiveResultElement) {
                        detectiveResultElement.textContent = `نتيجة تحقيقك عن ${investigatedPlayer.name}: ${investigatedPlayer.role.team === 'mafia' ? 'هو مافيا!' : 'هو مدني.'}`;
                        detectiveResultElement.className = `text-center font-bold mt-2 ${investigatedPlayer.role.team === 'mafia' ? 'text-red-300' : 'text-green-300'}`;
                    }
                }
            }
            
            // 4. تطبيق الاغتيال
            gameState.victimThisRound = null;
            if (gameState.mafiaChosenTargetId && gameState.mafiaChosenTargetId !== gameState.doctorSavedTargetId) {
                const victim = gameState.players.find(p => p.id === gameState.mafiaChosenTargetId);
                if (victim) {
                    victim.alive = false;
                    gameState.victimThisRound = victim;
                }
            }
            
            updateControls('<button id="next-phase-btn" class="btn-primary px-6 py-3 rounded-lg text-lg">إعلان النهار</button>');
            document.getElementById('next-phase-btn').addEventListener('click', startDayPhase); // الانتقال للنهار الجديد
            
            checkGameEnd(); // التحقق بعد كل ليل
        }

        // تحديث قائمة اللاعبين الأحياء
        function updateAlivePlayersList() {
            const alivePlayers = gameState.players.filter(p => p.alive);
            UI.alivePlayersList.innerHTML = '';
            if (alivePlayers.length === 0) {
                UI.alivePlayersList.innerHTML = '<p class="text-center text-gray-400">لا يوجد لاعبون أحياء!</p>';
                return;
            }
            alivePlayers.forEach(player => {
                const playerElement = document.createElement('div');
                playerElement.className = 'bg-gray-800 p-3 rounded-lg flex items-center shadow-sm';
                playerElement.innerHTML = `
                    <img src="${player.role.image}" alt="${player.role.name}" class="w-8 h-8 rounded-full mr-2">
                    <span class="font-semibold text-lg">${player.name}</span>
                `;
                UI.alivePlayersList.appendChild(playerElement);
            });
        }

        // التحقق من نهاية اللعبة
        function checkGameEnd() {
            const aliveMafia = gameState.players.filter(p => p.alive && p.role.team === 'mafia').length;
            const aliveCivilians = gameState.players.filter(p => p.alive && p.role.team === 'civilians').length;
            
            if (aliveMafia === 0 && gameState.gameStarted) { // تم القضاء على كل المافيا
                endGame('فوز المدنيين! لقد قضيتم على جميع المافيا!');
                return true;
            } else if (aliveMafia >= aliveCivilians && gameState.gameStarted) { // عدد المافيا يساوي أو يزيد عن المدنيين
                endGame('فوز المافيا! لقد سيطروا على البلدة!');
                return true;
            }
            return false;
        }

        // إنهاء اللعبة
        function endGame(message) {
            gameState.gameStarted = false;
            clearInterval(gameState.timer);
            
            UI.winnerText.textContent = message;
            UI.gameScreen.classList.add('hidden');
            UI.endScreen.classList.remove('hidden');
            
            // عرض ملخص اللاعبين
            let summaryHTML = '';
            
            gameState.players.forEach(player => {
                summaryHTML += `
                    <div class="player-status-card ${player.alive ? 'player-status-alive' : 'player-status-dead'}">
                        <img src="${player.role.image}" alt="${player.role.name}" class="w-10 h-10 rounded-full mr-3">
                        <div>
                            <p class="font-bold text-lg">${player.name} (${player.role.name})</p>
                            <p class="text-sm">${player.alive ? 'ناجي' : 'ميت'}</p>
                        </div>
                    </div>
                `;
            });
            
            UI.playersSummary.innerHTML = summaryHTML;
        }

        // بدء المؤقت
        function startTimer(callbackOnEnd) {
            clearInterval(gameState.timer);
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                UI.timer.textContent = formatTime(gameState.timeLeft);
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    if (callbackOnEnd) {
                        callbackOnEnd();
                    }
                }
            }, 1000);
        }

        // تحديث محتوى اللعبة
        function updateGameContent(content) {
            UI.gameContent.innerHTML = content;
        }

        // تحديث عناصر التحكم
        function updateControls(content) {
            UI.controls.innerHTML = content;
        }

        // إعادة تعيين اللعبة لحالة البدء
        function resetGame() {
            gameState.players = [];
            gameState.roles = [];
            gameState.currentPhase = 'day';
            gameState.currentRound = 0;
            gameState.gameStarted = false;
            clearInterval(gameState.timer);
            gameState.timeLeft = 0;
            gameState.lastDetectiveTargetId = null;
            gameState.lastDoctorTargetId = null;
            gameState.mafiaChosenTargetId = null;
            gameState.doctorSavedTargetId = null;
            gameState.victimThisRound = null;
            gameState.votedOutPlayerId = null;
            gameState.playersWhoVoted.clear();
            gameState.currentVoteCounts = {};
        }

        // ======= دوال مساعدة =======
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }
    </script>
</body>
</html>